<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Template - T·∫°o Template v·ªõi 2 B√†i h·ªçc v√† 2 B√†i t·∫≠p</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 2px solid #90caf9;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            border: 2px solid #81c784;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #ef5350;
        }
        
        .status.warning {
            background: #fff3e0;
            color: #f57c00;
            border: 2px solid #ffb74d;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            margin-top: 20px;
        }
        
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        
        .log-line {
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        
        .log-success { color: #4caf50; }
        .log-error { color: #f44336; }
        .log-warning { color: #ff9800; }
        .log-info { color: #2196f3; }
        
        .result-summary {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 600;
            color: #333;
        }
        
        .result-value {
            color: #666;
        }
        
        .result-value.success {
            color: #4caf50;
            font-weight: 600;
        }
        
        .result-value.error {
            color: #f44336;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test T·∫°o Template</h1>
        <p class="subtitle">T·ª± ƒë·ªông t·∫°o template v·ªõi 2 b√†i h·ªçc v√† 2 b√†i t·∫≠p</p>
        
        <div id="status" class="status info">
            ‚è≥ S·∫µn s√†ng ƒë·ªÉ test. Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu.
        </div>
        
        <button id="testBtn" onclick="runTest()">
            üöÄ B·∫Øt ƒë·∫ßu Test
        </button>
        
        <div id="logContainer" class="log-container" style="display: none;">
            <div id="logContent"></div>
        </div>
        
        <div id="resultSummary" class="result-summary" style="display: none;">
            <h3 style="margin-bottom: 15px;">üìä K·∫øt qu·∫£ Test</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${message}`;
            logs.push({ message: logLine, type });
            
            const logContent = document.getElementById('logContent');
            const logContainer = document.getElementById('logContainer');
            
            if (logContent) {
                const div = document.createElement('div');
                div.className = `log-line log-${type}`;
                div.textContent = logLine;
                logContent.appendChild(div);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(logLine);
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        function updateResult(result) {
            const resultSummary = document.getElementById('resultSummary');
            const resultContent = document.getElementById('resultContent');
            
            if (result.error) {
                resultContent.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">Tr·∫°ng th√°i:</span>
                        <span class="result-value error">‚ùå L·ªói</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Chi ti·∫øt:</span>
                        <span class="result-value error">${result.error}</span>
                    </div>
                `;
            } else {
                resultContent.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">Template ID:</span>
                        <span class="result-value">${result.templateId || 'N/A'}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">S·ªë b√†i h·ªçc:</span>
                        <span class="result-value ${result.lessonsCount === 2 ? 'success' : 'error'}">
                            ${result.lessonsCount}/2
                        </span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">S·ªë b√†i t·∫≠p:</span>
                        <span class="result-value ${result.assignmentsCount === 2 ? 'success' : 'error'}">
                            ${result.assignmentsCount}/2
                        </span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">K·∫øt qu·∫£:</span>
                        <span class="result-value ${result.success ? 'success' : 'error'}">
                            ${result.success ? '‚úÖ TH√ÄNH C√îNG' : '‚ö†Ô∏è CH∆ØA HO√ÄN T·∫§T'}
                        </span>
                    </div>
                `;
            }
            
            resultSummary.style.display = 'block';
        }
        
        async function runTest() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang ch·∫°y test...';
            
            const logContainer = document.getElementById('logContainer');
            logContainer.style.display = 'block';
            document.getElementById('logContent').innerHTML = '';
            logs = [];
            
            updateStatus('üîÑ ƒêang ki·ªÉm tra authentication...', 'info');
            log('üß™ B·∫Øt ƒë·∫ßu test t·∫°o template v·ªõi 2 b√†i h·ªçc v√† 2 b√†i t·∫≠p...', 'info');
            
            // H√†m ƒëƒÉng nh·∫≠p t·ª± ƒë·ªông
            async function login() {
                log('üîê ƒêang ƒëƒÉng nh·∫≠p t·ª± ƒë·ªông...', 'info');
                const loginData = {
                    email: 'admin@school.com',
                    password: 'password123'
                };
                
                const loginRes = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });
                
                if (!loginRes.ok) {
                    const errorText = await loginRes.text().catch(() => 'Unknown error');
                    throw new Error(`Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p: ${errorText}`);
                }
                
                const loginResult = await loginRes.json();
                const newToken = loginResult.access_token;
                localStorage.setItem('auth_token', newToken);
                localStorage.setItem('access_token', newToken);
                log('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
                return newToken;
            }
            
            // L·∫•y token ho·∫∑c ƒëƒÉng nh·∫≠p
            let token = localStorage.getItem('auth_token') || localStorage.getItem('access_token');
            
            // Ki·ªÉm tra token c√≥ h·ª£p l·ªá kh√¥ng b·∫±ng c√°ch th·ª≠ request
            if (token) {
                log('üîç ƒêang ki·ªÉm tra token...', 'info');
                const testRes = await fetch(`${API_BASE_URL}/api/subjects/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }).catch(() => ({ ok: false, status: 0 }));
                
                if (!testRes.ok || testRes.status === 401) {
                    log('‚ö†Ô∏è Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n. ƒêang ƒëƒÉng nh·∫≠p l·∫°i...', 'warning');
                    token = await login();
                } else {
                    log('‚úÖ Token h·ª£p l·ªá!', 'success');
                }
            } else {
                log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y token. ƒêang ƒëƒÉng nh·∫≠p...', 'warning');
                token = await login();
            }
            
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            try {
                // B∆∞·ªõc 1: L·∫•y danh s√°ch subjects v√† teachers
                updateStatus('üìã ƒêang l·∫•y danh s√°ch m√¥n h·ªçc v√† gi√°o vi√™n...', 'info');
                log('üìã B∆∞·ªõc 1: L·∫•y danh s√°ch m√¥n h·ªçc v√† gi√°o vi√™n...', 'info');
                
                const [subjectsRes, teachersRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/subjects/`, { headers }).catch(e => ({ ok: false, error: e })),
                    fetch(`${API_BASE_URL}/api/teachers/`, { headers }).catch(e => ({ ok: false, error: e }))
                ]);
                
                let subjects, teachers;
                
                if (!subjectsRes.ok) {
                    const errorText = subjectsRes.error ? subjectsRes.error.message : await subjectsRes.text().catch(() => 'Unknown error');
                    // N·∫øu v·∫´n l·ªói 401, th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i m·ªôt l·∫ßn n·ªØa
                    if (subjectsRes.status === 401 || (typeof errorText === 'string' && errorText.includes('credentials'))) {
                        log('‚ö†Ô∏è Token v·∫´n kh√¥ng h·ª£p l·ªá. ƒêang ƒëƒÉng nh·∫≠p l·∫°i...', 'warning');
                        token = await login();
                        headers.Authorization = `Bearer ${token}`;
                        // Th·ª≠ l·∫°i c·∫£ subjects v√† teachers
                        const [retrySubjectsRes, retryTeachersRes] = await Promise.all([
                            fetch(`${API_BASE_URL}/api/subjects/`, { headers }),
                            fetch(`${API_BASE_URL}/api/teachers/`, { headers })
                        ]);
                        if (!retrySubjectsRes.ok) {
                            throw new Error(`Kh√¥ng th·ªÉ l·∫•y danh s√°ch subjects sau khi ƒëƒÉng nh·∫≠p l·∫°i: ${await retrySubjectsRes.text()}`);
                        }
                        if (!retryTeachersRes.ok) {
                            throw new Error(`Kh√¥ng th·ªÉ l·∫•y danh s√°ch teachers: ${await retryTeachersRes.text()}`);
                        }
                        subjects = await retrySubjectsRes.json();
                        teachers = await retryTeachersRes.json();
                        log(`‚úÖ T√¨m th·∫•y ${subjects.length} m√¥n h·ªçc, ${teachers.length} gi√°o vi√™n`, 'success');
                    } else {
                        throw new Error(`Kh√¥ng th·ªÉ l·∫•y danh s√°ch subjects: ${errorText}`);
                    }
                } else {
                    if (!teachersRes.ok) {
                        const errorText = teachersRes.error ? teachersRes.error.message : await teachersRes.text().catch(() => 'Unknown error');
                        throw new Error(`Kh√¥ng th·ªÉ l·∫•y danh s√°ch teachers: ${errorText}`);
                    }
                    subjects = await subjectsRes.json();
                    teachers = await teachersRes.json();
                }
                
                const subjectId = subjects && subjects.length > 0 ? subjects[0].id : null;
                const teacherId = teachers && teachers.length > 0 ? teachers[0].id : null;
                
                log(`‚úÖ T√¨m th·∫•y ${subjects.length} m√¥n h·ªçc, ${teachers.length} gi√°o vi√™n`, 'success');
                
                // B∆∞·ªõc 2: T·∫°o template
                updateStatus('üìù ƒêang t·∫°o template...', 'info');
                log('\nüìù B∆∞·ªõc 2: T·∫°o template...', 'info');
                
                const templateData = {
                    name: 'Template Test - To√°n l·ªõp 10',
                    description: 'Template test v·ªõi 2 b√†i h·ªçc v√† 2 b√†i t·∫≠p',
                    capacity: 30,
                    subject_id: subjectId
                };
                
                const templateRes = await fetch(`${API_BASE_URL}/api/template-classrooms/`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(templateData)
                });
                
                if (!templateRes.ok) {
                    const error = await templateRes.text();
                    throw new Error(`L·ªói t·∫°o template: ${templateRes.status} - ${error}`);
                }
                
                const template = await templateRes.json();
                const templateId = template.id;
                log(`‚úÖ Template ƒë√£ ƒë∆∞·ª£c t·∫°o: ${template.name} (ID: ${templateId})`, 'success');
                
                // B∆∞·ªõc 3: T·∫°o 2 b√†i h·ªçc
                updateStatus('üìö ƒêang t·∫°o 2 b√†i h·ªçc...', 'info');
                log('\nüìö B∆∞·ªõc 3: T·∫°o 2 b√†i h·ªçc...', 'info');
                
                const lessons = [
                    {
                        title: 'B√†i h·ªçc 1: Gi·ªõi thi·ªáu v·ªÅ To√°n h·ªçc',
                        description: 'B√†i h·ªçc gi·ªõi thi·ªáu c√°c kh√°i ni·ªám c∆° b·∫£n v·ªÅ to√°n h·ªçc',
                        sort_order: 1
                    },
                    {
                        title: 'B√†i h·ªçc 2: Ph√©p t√≠nh c∆° b·∫£n',
                        description: 'H·ªçc v·ªÅ c√°c ph√©p t√≠nh c·ªông, tr·ª´, nh√¢n, chia',
                        sort_order: 2
                    }
                ];
                
                const createFakeFile = (name) => {
                    const content = 'Fake PDF content for testing';
                    return new Blob([content], { type: 'application/pdf' });
                };
                
                let lessonsCreated = 0;
                for (const lesson of lessons) {
                    const formData = new FormData();
                    formData.append('classroom_id', templateId);
                    formData.append('title', lesson.title);
                    formData.append('description', lesson.description);
                    formData.append('sort_order', lesson.sort_order.toString());
                    
                    const fakeFile = createFakeFile(`${lesson.title}.pdf`);
                    formData.append('files', fakeFile, `${lesson.title.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
                    
                    const lessonRes = await fetch(`${API_BASE_URL}/api/lessons/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    if (!lessonRes.ok) {
                        const error = await lessonRes.text();
                        log(`‚ö†Ô∏è L·ªói t·∫°o b√†i h·ªçc "${lesson.title}": ${lessonRes.status} - ${error}`, 'warning');
                    } else {
                        const lessonData = await lessonRes.json();
                        log(`‚úÖ ƒê√£ t·∫°o b√†i h·ªçc: ${lesson.title}`, 'success');
                        lessonsCreated++;
                    }
                }
                
                // B∆∞·ªõc 4: T·∫°o 2 b√†i t·∫≠p
                updateStatus('üìù ƒêang t·∫°o 2 b√†i t·∫≠p...', 'info');
                log('\nüìù B∆∞·ªõc 4: T·∫°o 2 b√†i t·∫≠p...', 'info');
                
                const assignments = [
                    {
                        title: 'B√†i t·∫≠p 1: Tr·∫Øc nghi·ªám To√°n c∆° b·∫£n',
                        description: 'B√†i t·∫≠p tr·∫Øc nghi·ªám v·ªÅ c√°c ph√©p t√≠nh c∆° b·∫£n',
                        assignment_type: 'multiple_choice',
                        total_points: 100.0,
                        time_limit_minutes: 60
                    },
                    {
                        title: 'B√†i t·∫≠p 2: T·ª± lu·∫≠n - Gi·∫£i b√†i to√°n',
                        description: 'B√†i t·∫≠p t·ª± lu·∫≠n y√™u c·∫ßu gi·∫£i c√°c b√†i to√°n',
                        assignment_type: 'essay',
                        total_points: 100.0,
                        time_limit_minutes: 0
                    }
                ];
                
                let assignmentsCreated = 0;
                for (const assignment of assignments) {
                    const assignmentData = {
                        ...assignment,
                        subject_id: subjectId,
                        teacher_id: teacherId
                    };
                    
                    const assignmentRes = await fetch(`${API_BASE_URL}/api/assignments/`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(assignmentData)
                    });
                    
                    if (!assignmentRes.ok) {
                        const error = await assignmentRes.text();
                        log(`‚ö†Ô∏è L·ªói t·∫°o b√†i t·∫≠p "${assignment.title}": ${assignmentRes.status} - ${error}`, 'warning');
                    } else {
                        const assignmentResult = await assignmentRes.json();
                        log(`‚úÖ ƒê√£ t·∫°o b√†i t·∫≠p: ${assignment.title} (ID: ${assignmentResult.id})`, 'success');
                        
                        // G√°n b√†i t·∫≠p cho template
                        const assignRes = await fetch(`${API_BASE_URL}/api/assignments/${assignmentResult.id}/classrooms`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify([templateId])  // FastAPI s·∫Ω parse List[str] t·ª´ JSON array
                        });
                        
                        if (assignRes.ok) {
                            log(`  ‚úÖ ƒê√£ g√°n b√†i t·∫≠p cho template`, 'success');
                            assignmentsCreated++;
                        } else {
                            log(`  ‚ö†Ô∏è Kh√¥ng th·ªÉ g√°n b√†i t·∫≠p cho template`, 'warning');
                        }
                    }
                }
                
                // B∆∞·ªõc 5: Ki·ªÉm tra k·∫øt qu·∫£
                updateStatus('üîç ƒêang ki·ªÉm tra k·∫øt qu·∫£...', 'info');
                log('\nüîç B∆∞·ªõc 5: Ki·ªÉm tra k·∫øt qu·∫£...', 'info');
                
                const [lessonsRes, assignmentsRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/template-classrooms/${templateId}/lessons`, { headers }),
                    fetch(`${API_BASE_URL}/api/template-classrooms/${templateId}/assignments`, { headers })
                ]);
                
                const templateLessons = await lessonsRes.json();
                const templateAssignments = await assignmentsRes.json();
                
                log(`\nüìä K·∫æT QU·∫¢:`, 'info');
                log(`‚úÖ Template ID: ${templateId}`, 'success');
                log(`‚úÖ S·ªë b√†i h·ªçc: ${templateLessons.length}/2`, templateLessons.length === 2 ? 'success' : 'warning');
                log(`‚úÖ S·ªë b√†i t·∫≠p: ${templateAssignments.length}/2`, templateAssignments.length === 2 ? 'success' : 'warning');
                
                if (templateLessons.length > 0) {
                    log(`\nüìö Danh s√°ch b√†i h·ªçc:`, 'info');
                    templateLessons.forEach((lesson, index) => {
                        log(`  ${index + 1}. ${lesson.title}`, 'info');
                    });
                }
                
                if (templateAssignments.length > 0) {
                    log(`\nüìù Danh s√°ch b√†i t·∫≠p:`, 'info');
                    templateAssignments.forEach((assignment, index) => {
                        log(`  ${index + 1}. ${assignment.title} (${assignment.assignment_type})`, 'info');
                    });
                }
                
                const success = templateLessons.length === 2 && templateAssignments.length === 2;
                
                if (success) {
                    updateStatus('üéâ TEST TH√ÄNH C√îNG! Template ƒë√£ c√≥ ƒë·ªß 2 b√†i h·ªçc v√† 2 b√†i t·∫≠p.', 'success');
                    log(`\nüéâ TEST TH√ÄNH C√îNG! Template ƒë√£ c√≥ ƒë·ªß 2 b√†i h·ªçc v√† 2 b√†i t·∫≠p.`, 'success');
                } else {
                    updateStatus('‚ö†Ô∏è TEST CH∆ØA HO√ÄN T·∫§T. C·∫ßn ki·ªÉm tra l·∫°i.', 'warning');
                    log(`\n‚ö†Ô∏è TEST CH∆ØA HO√ÄN T·∫§T. C·∫ßn ki·ªÉm tra l·∫°i.`, 'warning');
                }
                
                log(`\nüîó Xem template t·∫°i: http://localhost:3000/documents`, 'info');
                log(`üîó Xem chi ti·∫øt template t·∫°i: http://localhost:3000/classrooms/${templateId}`, 'info');
                
                updateResult({
                    templateId,
                    lessonsCount: templateLessons.length,
                    assignmentsCount: templateAssignments.length,
                    success
                });
                
            } catch (error) {
                updateStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                log(`‚ùå L·ªói trong qu√° tr√¨nh test: ${error.message}`, 'error');
                updateResult({ error: error.message });
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Ch·∫°y l·∫°i Test';
            }
        }
    </script>
</body>
</html>

